{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{% static '/css/diary/diary_make.css'%}">
  <link rel="stylesheet" href="{% static '/css/home/main.css'%}">
  <script  src="http://code.jquery.com/jquery-latest.min.js"></script>
  <title>가족 공유 다이어리 생성</title>
  
<!-- 공통 상단좌측메뉴 -->
<script>
  $(function() {
    // GNB 클릭
    $('#menu ul li').on('click', function() {
      $('#menu ul li').removeClass('active');
      $(this).addClass('active');
    });
      // 검색창
    $('#searchBtn').click(function(){
      $("#main_search").removeClass('closed').addClass('open');
      $('#s_overlay').addClass('show');
      });
    $('#search_closeBtn').click(function(){
      $("#main_search").removeClass('open').addClass('closed');
      $('#s_overlay').removeClass('show');
      });
    $('#s_overlay').click(function() { //배경 클릭하면 닫히게
      $('#main_search').removeClass('open').addClass('closed');
      $('#s_overlay').removeClass('show');
      });


    // 알림창
    $('#notiBtn').click(function() {
      $('#noti_side').removeClass('closed').addClass('open');
      $('#n_overlay').addClass('show');
      });
    $('#noti_closeBtn').click(function() {
      $('#noti_side').removeClass('open').addClass('closed');
      $('#n_overlay').removeClass('show');
      });
    $('#n_overlay').click(function() { //배경 클릭하면 닫히게
      $('#noti_side').removeClass('open').addClass('closed');
      $('#n_overlay').removeClass('show');
      });
  });


  $(function() {
    // GNB 클릭
    $('#menu ul li').on('click', function() {
      $('#menu ul li').removeClass('active');
      $(this).addClass('active');
    });
  });
</script>
</head>
<body>
<!-- 최상단 메뉴 -->
<div id="top_nav">
  <h1><a href="/main/index/"></a></h1>
  <ul class="top_menu">
    <li><a id="searchBtn"><img src="/static/images/home/search_icon.png" alt=""></a></li>
    <li><a id="notiBtn"><img src="/static/images/home/bell_off_icon.png" alt=""></a></li>
    <li><a href="/mypage/main/">마이페이지</a></li>
  </ul>

</div>

<!-- 좌측 gnb -->
<div id="gnb">

  <!-- 프로필 -->
  <div id="user_profile">
    <div id="pimg">
      <img src="/static/images/home/default_profile.png" alt="">
    </div>
    <p id="uName">김용준</p>
    <p id="uEmail">kyjoon0105@gmail.com</p>
  </div>

  <!-- Nav -->
  <nav id="menu">
    <ul>
      <a href="/main/index/"><li class="menu_item">우리 가족 이야기</li></a>
      <a href="/diary/diaryHome/"><li class="menu_item active">다이어리</li></a>
      <a href="/emotion/main/"><li class="menu_item">감정 돌아보기</li></a>
      <a href="/family1/fam/"><li class="menu_item">우리가족</li></a>
      <a href="/calendar1/cal/"><li class="menu_item">캘린더</li></a>
      <a href="/customer/"><li class="menu_item">알려드려요</li></a>
    </ul>
  </nav>

  <!-- logout -->
  <div id="logout">
    <a href="#"><span>로그아웃</span></a>
  </div>
  
</div>
<!-- 공통 상단좌측메뉴 -->
<!-- 검색창 슬라이드 -->
<div id="s_overlay" class="s_overlay"></div>
<div id="main_search" class="search_bar closed">
  <div id="input_wrap">
    <div class="search_box">
      <input type="text" placeholder="다이어리에서 찾고 싶은 내용을 입력하세요.">
      <img src="/static/images/home/search_icon.png" alt="">
    </div>
    <button type="button" id="search_closeBtn">
      <img src="/static/images/home/close_icon.png" alt="알림창닫기">
    </button>
  </div>
  
  <div id="search_content">
    <div id="search_result">
      검색 결과 <span>(4)</span>
    </div>
    <!-- 반복 -->
    <div class="search_list">
      <a href="">
        <span class="s_title">검색어가 들어간 기록의 제목이 들어가는 부분</span>
        <span class="s_date">2024.12.05</span>
        <img src="/static/images/home/right.png" alt="">
      </a>
    </div>
    <div class="search_list">
      <a href="">
        <span class="s_title">검색어가 들어간 기록의 제목이 들어가는 부분</span>
        <span class="s_date">2024.12.05</span>
        <img src="/static/images/home/right.png" alt="">
      </a>
    </div>
    <div class="search_list">
      <a href="">
        <span class="s_title">검색어가 들어간 기록의 제목이 들어가는 부분</span>
        <span class="s_date">2024.12.05</span>
        <img src="/static/images/home/right.png" alt="">
      </a>
    </div>
    <div class="search_list">
      <a href="">
        <span class="s_title">검색어가 들어간 기록의 제목이 들어가는 부분</span>
        <span class="s_date">2024.12.05</span>
        <img src="/static/images/home/right.png" alt="">
      </a>
    </div>
    <div class="search_list">
      <a href="">
        <span class="s_title">검색어가 들어간 기록의 제목이 들어가는 부분</span>
        <span class="s_date">2024.12.05</span>
        <img src="/static/images/home/right.png" alt="">
      </a>
    </div>
    <div class="search_list">
      <a href="">
        <span class="s_title">검색어가 들어간 기록의 제목이 들어가는 부분</span>
        <span class="s_date">2024.12.05</span>
        <img src="/static/images/home/right.png" alt="">
      </a>
    </div>
    <div class="search_list">
      <a href="">
        <span class="s_title">검색어가 들어간 기록의 제목이 들어가는 부분</span>
        <span class="s_date">2024.12.05</span>
        <img src="/static/images/home/right.png" alt="">
      </a>
    </div>
    <div class="search_list">
      <a href="">
        <span class="s_title">검색어가 들어간 기록의 제목이 들어가는 부분</span>
        <span class="s_date">2024.12.05</span>
        <img src="/static/images/home/right.png" alt="">
      </a>
    </div>
    <!-- 반복 -->
    
  </div>
  
  
</div>

<!-- 알림창 슬라이드 -->
<div id="n_overlay" class="n_overlay"></div>
<div id="noti_side" class="sidebar closed">
  <div class="noti_header">
    <h2>알림</h2>
    <button id="noti_closeBtn"><img src="/static/images/home/close_icon.png" alt="알림창닫기"></button>
  </div>
  <ul id="noti_list">
    <li class="noti_list">
      <a href="">
        <div>
          <img src="/static/images/home/default_profile.png" alt="프로필이미지">
        </div>
        <div>
          <p>장서윤 님이 새로운 기록을 공유했어요.</p>
        </div>
      </a>
    </li>
    <li class="noti_list checked">
      <a href="">
        <div>
          <img src="/static/images/home/default_profile.png" alt="프로필이미지">
        </div>
        <div>
          <p>배현지 님이 용준님의 기록에 좋아요를 눌렀어요.</p>
        </div>
      </a>
    </li>
    <li class="noti_list checked">
      <a href="">
        <div>
          <img src="/static/images/home/default_profile.png" alt="프로필이미지">
        </div>
        <div>
          <p>이다영 님이 용준님의 기록에 댓글을 남겼어요.</p>
        </div>
      </a>
    </li>
    <li class="noti_list checked">
      <a href="">
        <div>
          <img src="/static/images/home/default_profile.png" alt="프로필이미지">
        </div>
        <div>
          <p>정종원 님이 용준님의 기록에 좋아요를 남겼어요.</p>
        </div>
      </a>
    </li>
  </ul>
</div>


<!-- 다이어리 HOME -->
<div id="all_area">
  <!-- 상단부분 -->
  <div id="title_area">
    <p id="topTit">가족 공유 다이어리 만들기</p>      
  </div>

  <!-- 메인부분 -->
  <div id="main_area">
    <div class="container">
      <img id="diaryImg" src="/static/images/diary/diaryMake.png" alt="Family Diary Background">
      <form action="" method="post" id="diaryFrm" name="diaryFrm">
        {% csrf_token %}
        <div class="title_container">
          <div>
            <span>다이어리 제목</span>
          </div>
          <div>
            <input type="text" id="title" name='gtitle' class="title_input" placeholder="제목을 입력하세요." maxlength="20"></input>
          </div>
          
          <div id="groupName">
            <span>가족 이름</span><br>
            <div class="gName_container">
              <input type="text" id='gName' name="gName" class="familyName" placeholder="우리 가족의 이름을 정해보세요." maxlength="20">
            </div>
          </div>
          
          <div id="mem_search">
            <span>추가할 가족 검색</span><br>
            <div id="search_container">
              <input id="searchBar" class="searchBar" type="text" name="search" placeholder="검색">
              <button type="button">검색</button>
              <ul id="mList" style='display: none;'>
                {% for member in members %}
                <li>
                  <span class="id-class">{{ member.id }}</span>
                  <span class="name-class">{{ member.name }}</span>
                  <span class="join-class">{{ member.joined_group }}</span>
                </li>
                {% endfor %}
              </ul>
            </div>
            <div id="memberList">
              
            </div>
          </div>
        
          <div id="date_search">
            <span>다이어리 생성일</span><br>
            <input type="date" id='gdate' name='created_at' class="date_input">
          </div>
          <div id="save_area">
            <button id="saveBtn" type='button'><img src="/static/images/diary/saveBtn.png" alt=""></button>
            <button id="cancelBtn" type='button'><img src="/static/images/diary/cancleBtn.png" alt=""></button>
          </div>
        
        </div>
      </form>
    </div>
  </div>
    
  <!-- 스크립트 부분 -->
  <script>
    $(document).ready(function () {
      const members = []; // ID와 Name을 저장
    
      // 로그인된 유저 ID 가져오기
      const loggedInUserId = "{{ request.session.session_id }}"; // Django 템플릿에서 전달
    
      // #mList의 각 회원 데이터를 배열로 저장
      $('#mList li').each(function () {
        const memberId = $(this).find('.id-class').text().trim(); // ID 클래스
        const memberName = $(this).find('.name-class').text().trim(); // 이름 클래스
        const memberJoin = $(this).find('.join-class').text().trim(); // Join 상태
        members.push({ id: memberId, name: memberName, join: memberJoin });
      });
    
      // 검색 로직
      const searchMember = function () {
        const input_id = $('#searchBar').val().trim();
        console.log("입력값:", input_id);
    
        // 로그인된 유저 검색 방지
        if (input_id === loggedInUserId) {
          alert("본인은 추가할 수 없습니다.");
          $("#searchBar").val(''); // 검색창 초기화
          return;
        }
    
        const member = members.find(m => m.id === input_id);
        console.log("검색 결과:", member);
    
        if (member) {
          if (!member.join || member.join === 'None' || member.join.trim() === '') {
            // join 값이 없거나 비어 있을 때
            if ($('#memberList').text().includes(member.name)) {
              alert(`"${member.name}" 회원은 이미 추가되어 있습니다.`);
              return;
            }
            $('#memberList').append(`<div class='nicName'>${member.name}</div>`);
            $('#diaryFrm').append(`<input type="hidden" name="search_members[]" value="${member.id}">`);
            alert(`"${input_id}" 회원을 찾았어요! 가족으로 추가했습니다.`);
          } else {
            alert(`"${input_id}" 회원은 이미 다른 그룹에 속해 있어요.`);
          }
        } else {
          alert(`"${input_id}"는 회원 정보와 일치하지 않아요.`);
        }
    
        $("#searchBar").val(''); // 검색창 초기화
      };
    
      // 검색 버튼 클릭 이벤트 처리
      $('#search_container button').on('click', function () {
        searchMember();
      });
    
      // 엔터키 입력 이벤트 처리
      $('#searchBar').on('keypress', function (event) {
        if (event.key === 'Enter') {
          event.preventDefault(); // 기본 제출 방지
          searchMember();
        }
      });
    
      // 저장버튼
      $("#saveBtn").click(function(){
        if($("#title").val().length<1){
          alert("다이어리 제목을 입력하세요.");
          return false;
        }
        if($("#gName").val().length<1){
          alert("가족 이름을 입력하세요.");
          return false;
        }
        if ($("#memberList").children().length < 1) {
          alert("가족을 추가하세요.");
          return false;
        }
        diaryFrm.submit()
      });
    });
  </script>


  
</body>
</html>